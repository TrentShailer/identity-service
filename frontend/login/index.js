var g=class{element;contents;action;constructor(t,n){this.element=l(`${t}/error`,HTMLElement),this.contents=l(`${t}/error/content`,HTMLElement),this.action=n}clearError(){this.element.classList.add("collapse"),this.element.ariaHidden="true",this.contents.textContent=""}addError(t){if(this.contents.textContent===""){this.element.classList.remove("collapse"),this.element.ariaHidden="false",this.contents.textContent=`Could not ${this.action}: ${t}`;return}this.contents.textContent+=`, ${t}`}panic(){this.element.classList.remove("collapse"),this.element.ariaHidden="false",this.contents.textContent=`Something went wrong while trying to ${this.action}. Try again later.`}},k=class{input;error;constructor(t,n){this.input=l(`${t}${n}/input`,HTMLInputElement),this.error=l(`${t}${n}/error`,HTMLElement),this.input.addEventListener("input",()=>{this.input.setCustomValidity("")})}getValue(){return this.input.type==="checkbox"?this.input.checked?"checked":"unchecked":this.input.value}setLock(t){this.input.disabled=t}clearError(){this.input.setCustomValidity(""),this.error.classList.add("hidden"),this.error.ariaHidden="true",this.error.textContent="!"}addError(t){if(this.error.textContent==="!"){this.input.setCustomValidity(t),this.error.classList.remove("hidden"),this.error.ariaHidden="false",this.error.textContent=`Invalid value: ${t}`;return}this.error.textContent+=`, ${t}`,this.input.setCustomValidity(this.error.textContent??"Invalid value")}},w=class{form;formError;submitButton;inputs;constructor(t,n,s){this.form=l(t,HTMLFormElement),this.formError=new g(t,s),this.submitButton=l(`${t}/submit`,HTMLButtonElement);let r=new Map;for(let u of n)r.set(u,new k(t,u));this.inputs=r}clearErrors(){this.formError.clearError();for(let t of this.inputs.values())t.clearError()}setLock(t){this.submitButton.disabled=t;for(let n of this.inputs.values())n.setLock(t)}setInputErrors(t){if(!t||t.length===0){this.formError.addError("an unknown field is invalid");return}for(let n of t){let s=this.inputs.get(n.pointer)??null;s?s.addError(n.detail):this.formError.addError(`field ${n.pointer} ${n.detail}`)}}getValues(){let t=new Map;for(let[n,s]of this.inputs)t.set(n,s.getValue());return t}};function l(e,t){let n=document.getElementById(e);if(!n||!(n instanceof t))throw`element '${e}' does not exist`;return n}async function m(e){return location.href=e,await O()}function O(){let e=t=>{setTimeout(()=>e(t),400)};return new Promise(e)}function C(e){return Uint8Array.fromBase64(e,{alphabet:"base64url",lastChunkHandling:"loose"})}function d(e){return e.toBase64({alphabet:"base64url",omitPadding:!0})}var y="ts_token",i=class{#t;#e;#n=null;#s=null;constructor(t,n){this.#t=t,this.#e=n}setBody(t){return this.#s=t,this}setHeaders(t){return this.#n=t,this}async fetch(){return await I(this.#t,this.#e,this.#n,this.#s)}};function T(e){Object.defineProperty(globalThis,"tokenDomain",{value:e,writable:!0,configurable:!0})}async function b(){let e=await globalThis.window.cookieStore.get(y);if(!e)return null;let t=e.value.split(".");if(t.length!==3)return await P(),null;let n=new TextDecoder,s=JSON.parse(n.decode(C(t[1])));return{bearer:e.value,claims:s}}async function P(){console.info("deleting token"),await globalThis.window.cookieStore.delete(y)}async function S(e){if(globalThis.tokenDomain==null||globalThis.tokenDomain==null)throw new Error("`globalThis.tokenDomain` has not been set, token cannot be saved.");console.info("setting token"),await globalThis.window.cookieStore.set({domain:globalThis.tokenDomain,name:y,value:e,sameSite:"strict",expires:Date.now()+1e3*60*60*24*30,partitioned:void 0,path:void 0})}async function I(e,t,n,s){let r=new Headers;if(n)for(let o of n)r.append(o[0],o[1]);s&&r.append("content-type","application/json");let u=await b();u&&!r.has("Authorization")&&r.append("Authorization",u.bearer);let c=null;s&&(c=JSON.stringify(s));let h=await self.fetch(t,{method:e,body:c,headers:r}).catch(o=>(console.warn(o),new Response(null,{status:500})));if(h.ok){let o=h.headers.get("Authorization");return o&&await S(o),{status:"ok",body:await h.json().catch(L=>(console.warn(L),{}))}}switch(h.status){case 400:return{status:"badRequest",problems:(await h.json().catch(x=>(console.warn(x),{problems:[]}))).problems??[]};case 401:case 403:return{status:"unauthenticated"}}return{status:"error"}}var p="http://localhost:8081",f=["X-TS-API-Key","identity-site"];function A(){T("")}async function v(){let e=await b();return e?{bearer:e.bearer,act:e.claims.act??null,exp:e.claims.exp,sub:e.claims.sub,typ:e.claims.typ,tid:e.claims.tid}:null}async function E(e){let t=await U(null);if(t.status!=="ok")return t;let n=await $();if(n.status!=="ok")return n;let s=await D(null,e);if(s.status!=="ok")return s;let r={challenge:t.data,allowCredentials:s.data,hints:["security-key","hybrid","client-device"],rpId:n.data.id,userVerification:"required"},u=PublicKeyCredential.parseRequestOptionsFromJSON(r),c=await navigator.credentials.get({publicKey:u}).catch(()=>null);return c?c instanceof PublicKeyCredential?await B(c,"common",null):{status:"error"}:{status:"cancelled"}}async function $(){let e=await new i("GET",p+"/.well-known/relying-party.json").setHeaders([f]).fetch();return e.status==="ok"?{status:"ok",data:e.body}:e.status==="unauthenticated"?{status:"unauthenticated"}:{status:"error"}}async function D(e,t){let n="";e?n=`?identityId=${e}`:t&&(n=`?username=${t}`);let s=await new i("GET",p+`/existing-credentials${n}`).setHeaders([f]).fetch();return s.status==="ok"?{status:"ok",data:s.body.credentials}:s.status==="unauthenticated"?{status:"unauthenticated"}:{status:"error"}}async function U(e){let t=await new i("POST",p+"/challenges").setBody({identityId:e}).setHeaders([f]).fetch();return t.status==="ok"?{status:"ok",data:t.body.challenge}:t.status==="unauthenticated"?{status:"unauthenticated"}:{status:"error"}}async function B(e,t,n){if(!(e.response instanceof AuthenticatorAssertionResponse))return{status:"error"};let s=await new i("POST",p+"/tokens").setHeaders([f]).setBody({credential:{id:e.id,authenticatorAttachment:e.authenticatorAttachment,rawId:d(new Uint8Array(e.rawId)),response:{authenticatorData:d(new Uint8Array(e.response.authenticatorData)),clientDataJSON:d(new Uint8Array(e.response.clientDataJSON)),signature:d(new Uint8Array(e.response.signature)),userHandle:e.response.userHandle?d(new Uint8Array(e.response.userHandle)):null}},typ:t,act:n}).fetch();if(s.status==="unauthenticated")return{status:"unauthenticated"};if(s.status!=="ok")return{status:"error"};let r=localStorage.getItem(y);return r?{status:"ok",data:r}:{status:"error"}}A();var H=await v();if(H)switch(H.typ){case"common":await m("/identity");break;case"provisioning":await m("/add-passkey");break}var a=new w("/login",["/username"],"login");document.getElementById("prompt-resident-key").addEventListener("mouseup",async()=>{a.clearErrors();let e=await E(null);if(e.status==="ok")await K();else if(e.status==="cancelled"){a.formError.addError("the prompt was cancelled");return}else{a.formError.panic();return}});a.form.addEventListener("submit",async e=>{try{e.preventDefault(),a.setLock(!0),a.clearErrors();let n=a.getValues().get("/username")??"",s=await E(n);if(s.status==="ok")await K();else if(s.status==="cancelled"){a.formError.addError("the prompt was cancelled"),a.setLock(!1);return}else{a.formError.panic(),a.setLock(!1);return}}finally{a.setLock(!1)}});async function K(){let t=new URLSearchParams(document.location.search).get("redirect"),n=t?decodeURI(t):"/identity";return await m(n)}
//# sourceMappingURL=index.js.map
