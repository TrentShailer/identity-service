function p(t){return t.toBase64({alphabet:"base64url",omitPadding:!0})}async function h(t){return location.href=t,await R()}function R(){let t=e=>{setTimeout(()=>t(e),400)};return new Promise(t)}var d="token",i=class{#e;#t;#r=null;#n=null;#s=null;#o=!1;constructor(e,r){this.#e=e,this.#t=r}setBody(e){return this.#n=e,this}setHeaders(e){return this.#r=e,this}setLogout(e,r){return this.#s=e,this.#o=r,this}async fetch(){return await T(this.#e,this.#t,this.#r,this.#n,this.#s,this.#o)}};async function T(t,e,r,n,o,g){let m=new Headers;if(r)for(let l of r)m.append(l[0],l[1]);n&&m.append("content-type","application/json");let b=localStorage.getItem(d);b&&!m.has("Authorization")&&m.append("Authorization",b);let k=null;n&&(k=JSON.stringify(n));let a=await self.fetch(e,{method:t,body:k,headers:m}).catch(l=>(console.warn(l),new Response(null,{status:500})));if(a.ok){let l=a.headers.get("Authorization");return l&&localStorage.setItem(d,l),{status:"ok",body:await a.json().catch(I=>(console.warn(I),{}))}}else return a.status===401?(o&&await L(o,g),{status:"unauthorized"}):a.status===404?{status:"notFound"}:a.status>=400&&a.status<500?{status:"clientError",problems:(await a.json().catch(x=>(console.warn(x),{problems:[]}))).problems??[]}:{status:"serverError"}}async function L(t,e){let r=localStorage.getItem(d);await new i("DELETE",t.deleteTokenEndpoint).setHeaders(t.additionalHeaders).fetch(),localStorage.removeItem(d),r&&alert("Your session has expired");let n=e?`${t.loginHref}?redirect=${encodeURI(location.href)}`:t.loginHref;return await h(n)}var w=class{element;contents;constructor(e){this.element=f(`${e}/error`,HTMLElement),this.contents=f(`${e}/error/content`,HTMLElement)}clearError(){this.element.classList.add("collapse"),this.element.ariaHidden="true",this.contents.textContent=""}addError(e){if(this.contents.textContent===""){this.setError(`Invalid form: ${e}`);return}this.contents.textContent+=`, ${e}`}setError(e){this.element.classList.remove("collapse"),this.element.ariaHidden="false",this.contents.textContent=e}unexpectedResponse(e){this.setError(`Could not ${e} because the server sent an unexpected response.`)}},y=class{input;error;constructor(e,r){this.input=f(`${e}${r}/input`,HTMLInputElement),this.error=f(`${e}${r}/error`,HTMLElement),this.input.addEventListener("input",()=>{this.input.setCustomValidity("")})}getValue(){return this.input.type==="checkbox"?this.input.checked?"checked":"unchecked":this.input.value}lock(){this.input.disabled=!0}unlock(){this.input.disabled=!1}clearError(){this.input.setCustomValidity(""),this.error.classList.add("hidden"),this.error.ariaHidden="true",this.error.textContent="!"}addError(e){if(this.error.textContent==="!"){this.setError(`Invalid value: ${e}`);return}this.error.textContent+=`, ${e}`,this.input.setCustomValidity(this.error.textContent??"Invalid value")}setError(e){this.input.setCustomValidity(e),this.error.classList.remove("hidden"),this.error.ariaHidden="false",this.error.textContent=e}},E=class{form;formError;submitButton;inputs;constructor(e,r){this.form=f(e,HTMLFormElement),this.formError=new w(e),this.submitButton=f(`${e}/submit`,HTMLButtonElement);let n=new Map;for(let o of r)n.set(o,new y(e,o));this.inputs=n}clearErrors(){this.formError.clearError();for(let e of this.inputs.values())e.clearError()}lock(){this.submitButton.disabled=!0;for(let e of this.inputs.values())e.lock()}unlock(){this.submitButton.disabled=!1;for(let e of this.inputs.values())e.unlock()}setInputErrors(e){if(!e||e.length===0){this.formError.addError("an unknown field is invalid");return}for(let r of e){let n=null;r.pointer&&(n=this.inputs.get(r.pointer)??null),n&&r.detail?n.addError(r.detail):n&&!r.detail?n.addError("unknown reason"):!n&&r.detail?this.formError.addError(r.detail):this.formError.addError("an unknown field is invalid")}}getValues(){let e=new Map;for(let[r,n]of this.inputs)e.set(r,n.getValue());return e}};function f(t,e){let r=document.getElementById(t);if(!r||!(r instanceof e))throw`element '${t}' does not exist`;return r}var u="http://localhost:8081",c=["X-TS-API-Key","identity-site"],K={deleteTokenEndpoint:u+"/tokens/current",loginHref:"/login",additionalHeaders:[c]};async function v(){let t=await new i("GET",u+"/tokens/current").setHeaders([c]).fetch();return t.status==="serverError"||t.status==="clientError"||t.status==="unauthorized"?(localStorage.removeItem(d),null):t.status==="ok"?t.body:(localStorage.removeItem(d),null)}var H=await v();if(H)switch(H.typ){case"common":await h("/identity");break;case"provisioning":await h("/add-passkey");break}var s=new E("/login",["/username"]);document.getElementById("prompt-resident-key").addEventListener("mouseup",async()=>{s.clearErrors();let t=await C(null);if(console.log(t),!t){s.formError.unexpectedResponse("get credential request options");return}let e=await navigator.credentials.get({publicKey:t}).catch(()=>null);if(!e||!(e instanceof PublicKeyCredential)||!(e.response instanceof AuthenticatorAssertionResponse)){s.formError.setError("Could not login because the prompt was cancelled.");return}await A(e)==="clientError"?s.formError.setError("Invalid credential."):s.formError.unexpectedResponse("login")});s.form.addEventListener("submit",async t=>{try{t.preventDefault(),s.lock(),s.clearErrors();let r=s.getValues().get("/username")??"",n=await C(r);if(console.log(n),!n){s.formError.unexpectedResponse("get credential request options"),s.unlock();return}let o=await navigator.credentials.get({publicKey:n}).catch(()=>null);if(!o||!(o instanceof PublicKeyCredential)||!(o.response instanceof AuthenticatorAssertionResponse)){s.formError.setError("Could not login because the prompt was cancelled."),s.unlock();return}await A(o)==="clientError"?s.formError.setError("Invalid credential."):s.formError.unexpectedResponse("login")}finally{s.unlock()}});async function C(t){let e=await new i("GET",u+"/credential-request-options").setHeaders([c]).fetch();if(e.status!=="ok")return null;let r=e.body,n=await new i("POST",u+"/challenges").setHeaders([c]).setBody({identityId:null}).fetch();if(n.status!=="ok")return null;if(r.challenge=n.body.challenge,t){let o=await new i("GET",u+`/allowed-credentials/${t}`).setHeaders([c]).fetch();if(o.status!=="ok")return null;r.allowCredentials=o.body.allowCredentials}return PublicKeyCredential.parseRequestOptionsFromJSON(r)}async function A(t){if(!(t.response instanceof AuthenticatorAssertionResponse))return"clientError";let e=await new i("POST",u+"/tokens").setHeaders([c]).setBody({credential:{id:t.id,authenticatorAttachment:t.authenticatorAttachment,rawId:p(new Uint8Array(t.rawId)),response:{authenticatorData:p(new Uint8Array(t.response.authenticatorData)),clientDataJSON:p(new Uint8Array(t.response.clientDataJSON)),signature:p(new Uint8Array(t.response.signature)),userHandle:t.response.userHandle?p(new Uint8Array(t.response.userHandle)):null}},typ:"common"}).fetch();if(e.status==="ok"){let n=new URLSearchParams(document.location.search).get("redirect"),o=n?decodeURI(n):"/identity";return await h(o)}return e.status==="serverError"?"serverError":"clientError"}
//# sourceMappingURL=index.js.map
