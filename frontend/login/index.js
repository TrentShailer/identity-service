var g=class{element;contents;action;constructor(t,n){this.element=d(`${t}/error`,HTMLElement),this.contents=d(`${t}/error/content`,HTMLElement),this.action=n}clearError(){this.element.classList.add("collapse"),this.element.ariaHidden="true",this.contents.textContent=""}addError(t){if(this.contents.textContent===""){this.element.classList.remove("collapse"),this.element.ariaHidden="false",this.contents.textContent=`Could not ${this.action}: ${t}`;return}this.contents.textContent+=`, ${t}`}panic(){this.element.classList.remove("collapse"),this.element.ariaHidden="false",this.contents.textContent=`Something went wrong while trying to ${this.action}. Try again later.`}},b=class{input;error;constructor(t,n){this.input=d(`${t}${n}/input`,HTMLInputElement),this.error=d(`${t}${n}/error`,HTMLElement),this.input.addEventListener("input",()=>{this.input.setCustomValidity("")})}getValue(){return this.input.type==="checkbox"?this.input.checked?"checked":"unchecked":this.input.value}setLock(t){this.input.disabled=t}clearError(){this.input.setCustomValidity(""),this.error.classList.add("hidden"),this.error.ariaHidden="true",this.error.textContent="!"}addError(t){if(this.error.textContent==="!"){this.input.setCustomValidity(t),this.error.classList.remove("hidden"),this.error.ariaHidden="false",this.error.textContent=`Invalid value: ${t}`;return}this.error.textContent+=`, ${t}`,this.input.setCustomValidity(this.error.textContent??"Invalid value")}},w=class{form;formError;submitButton;inputs;constructor(t,n,r){this.form=d(t,HTMLFormElement),this.formError=new g(t,r),this.submitButton=d(`${t}/submit`,HTMLButtonElement);let s=new Map;for(let u of n)s.set(u,new b(t,u));this.inputs=s}clearErrors(){this.formError.clearError();for(let t of this.inputs.values())t.clearError()}setLock(t){this.submitButton.disabled=t;for(let n of this.inputs.values())n.setLock(t)}setInputErrors(t){if(!t||t.length===0){this.formError.addError("an unknown field is invalid");return}for(let n of t){let r=this.inputs.get(n.pointer)??null;r?r.addError(n.detail):this.formError.addError(`field ${n.pointer} ${n.detail}`)}}getValues(){let t=new Map;for(let[n,r]of this.inputs)t.set(n,r.getValue());return t}};function d(e,t){let n=document.getElementById(e);if(!n||!(n instanceof t))throw`element '${e}' does not exist`;return n}async function y(e){return location.href=e,await H()}function H(){let e=t=>{setTimeout(()=>e(t),400)};return new Promise(e)}function x(e){return Uint8Array.fromBase64(e,{alphabet:"base64url",lastChunkHandling:"loose"})}function p(e){return e.toBase64({alphabet:"base64url",omitPadding:!0})}var c="token",i=class{#t;#e;#n=null;#r=null;constructor(t,n){this.#t=t,this.#e=n}setBody(t){return this.#r=t,this}setHeaders(t){return this.#n=t,this}async fetch(){return await v(this.#t,this.#e,this.#n,this.#r)}};async function v(e,t,n,r){let s=new Headers;if(n)for(let o of n)s.append(o[0],o[1]);r&&s.append("content-type","application/json");let u=localStorage.getItem(c);u&&!s.has("Authorization")&&s.append("Authorization",u);let l=null;r&&(l=JSON.stringify(r));let m=await self.fetch(t,{method:e,body:l,headers:s}).catch(o=>(console.warn(o),new Response(null,{status:500})));if(m.ok){let o=m.headers.get("Authorization");return o&&localStorage.setItem(c,o),{status:"ok",body:await m.json().catch(K=>(console.warn(K),{}))}}switch(m.status){case 400:return{status:"badRequest",problems:(await m.json().catch(E=>(console.warn(E),{problems:[]}))).problems??[]};case 401:case 403:return{status:"unauthenticated"}}return{status:"error"}}var h="http://localhost:8081",f=["X-TS-API-Key","identity-site"];function C(){let e=localStorage.getItem(c);if(!e)return null;let t=e.split(".");if(t.length!==3)return localStorage.removeItem(c),null;let n=new TextDecoder,r=JSON.parse(n.decode(x(t[1])));return{bearer:e,act:r.act??null,exp:r.exp,sub:r.sub,typ:r.typ,tid:r.tid}}async function k(e){let t=await L(null);if(t.status!=="ok")return t;let n=await I();if(n.status!=="ok")return n;let r=await T(null,e);if(r.status!=="ok")return r;let s={challenge:t.data,allowCredentials:r.data,hints:["security-key","hybrid","client-device"],rpId:n.data.id,userVerification:"required"},u=PublicKeyCredential.parseRequestOptionsFromJSON(s),l=await navigator.credentials.get({publicKey:u}).catch(()=>null);return l?l instanceof PublicKeyCredential?await S(l,"common",null):{status:"error"}:{status:"cancelled"}}async function I(){let e=await new i("GET",h+"/.well-known/relying-party.json").setHeaders([f]).fetch();return e.status==="ok"?{status:"ok",data:e.body}:e.status==="unauthenticated"?{status:"unauthenticated"}:{status:"error"}}async function T(e,t){let n="";e?n=`?identityId=${e}`:t&&(n=`?username=${t}`);let r=await new i("GET",h+`/existing-credentials${n}`).setHeaders([f]).fetch();return r.status==="ok"?{status:"ok",data:r.body.credentials}:r.status==="unauthenticated"?{status:"unauthenticated"}:{status:"error"}}async function L(e){let t=await new i("POST",h+"/challenges").setBody({identityId:e}).setHeaders([f]).fetch();return t.status==="ok"?{status:"ok",data:t.body.challenge}:t.status==="unauthenticated"?{status:"unauthenticated"}:{status:"error"}}async function S(e,t,n){if(!(e.response instanceof AuthenticatorAssertionResponse))return{status:"error"};let r=await new i("POST",h+"/tokens").setHeaders([f]).setBody({credential:{id:e.id,authenticatorAttachment:e.authenticatorAttachment,rawId:p(new Uint8Array(e.rawId)),response:{authenticatorData:p(new Uint8Array(e.response.authenticatorData)),clientDataJSON:p(new Uint8Array(e.response.clientDataJSON)),signature:p(new Uint8Array(e.response.signature)),userHandle:e.response.userHandle?p(new Uint8Array(e.response.userHandle)):null}},typ:t,act:n}).fetch();if(r.status==="unauthenticated")return{status:"unauthenticated"};if(r.status!=="ok")return{status:"error"};let s=localStorage.getItem(c);return s?{status:"ok",data:s}:{status:"error"}}var P=C();if(P)switch(P.typ){case"common":await y("/identity");break;case"provisioning":await y("/add-passkey");break}var a=new w("/login",["/username"],"login");document.getElementById("prompt-resident-key").addEventListener("mouseup",async()=>{a.clearErrors();let e=await k(null);if(e.status==="ok")await A();else if(e.status==="cancelled"){a.formError.addError("the prompt was cancelled");return}else{a.formError.panic();return}});a.form.addEventListener("submit",async e=>{try{e.preventDefault(),a.setLock(!0),a.clearErrors();let n=a.getValues().get("/username")??"",r=await k(n);if(r.status==="ok")await A();else if(r.status==="cancelled"){a.formError.addError("the prompt was cancelled"),a.setLock(!1);return}else{a.formError.panic(),a.setLock(!1);return}}finally{a.setLock(!1)}});async function A(){let t=new URLSearchParams(document.location.search).get("redirect"),n=t?decodeURI(t):"/identity";return await y(n)}
//# sourceMappingURL=index.js.map
