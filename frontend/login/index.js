// deno-lint-ignore-file
// deno-fmt-ignore-file
// @ts-nocheck
function p(t){return t.toBase64({alphabet:"base64url",omitPadding:!0})}async function i(t){return location.href=t,await A()}function A(){let t=e=>{setTimeout(()=>t(e),400)};return new Promise(t)}var f="token",a=class{#e;#t;#r=null;#n=null;#s=null;#o=!1;constructor(e,r){this.#e=e,this.#t=r}setBody(e){return this.#n=e,this}setHeaders(e){return this.#r=e,this}setLogout(e,r){return this.#s=e,this.#o=r,this}async fetch(){return await L(this.#e,this.#t,this.#r,this.#n,this.#s,this.#o)}};async function L(t,e,r,n,o,b){let E=new Headers;if(r)for(let u of r)E.append(u[0],u[1]);n&&E.append("content-type","application/json");let v=localStorage.getItem(f);v&&E.append("Authorization",v);let x=null;n&&(x=JSON.stringify(n));let c=await self.fetch(e,{method:t,body:x,headers:E}).catch(u=>(console.warn(u),new Response(null,{status:500})));if(c.ok){let u=c.headers.get("Authorization");return u&&localStorage.setItem(f,u),{status:"ok",body:await c.json().catch(T=>(console.warn(T),{}))}}else return c.status===401?(o&&await m(o,b),{status:"unauthorized"}):c.status===404?{status:"notFound"}:c.status>=400&&c.status<500?{status:"clientError",problems:(await c.json().catch(H=>(console.warn(H),{problems:[]}))).problems??[]}:{status:"serverError"}}async function m(t,e){let r=localStorage.getItem(f);await new a("DELETE",t.deleteTokenEndpoint).setHeaders(t.additionalHeaders).fetch(),localStorage.removeItem(f),r&&alert("Your session has expired");let n=e?`${t.loginHref}?redirect=${encodeURI(location.href)}`:t.loginHref;return await i(n)}var g=class{element;contents;constructor(e){this.element=h(`${e}/error`,HTMLElement),this.contents=h(`${e}/error/content`,HTMLElement)}clearError(){this.element.classList.add("collapse"),this.element.ariaHidden="true",this.contents.textContent=""}addError(e){if(this.contents.textContent===""){this.setError(`Invalid form: ${e}`);return}this.contents.textContent+=`, ${e}`}setError(e){this.element.classList.remove("collapse"),this.element.ariaHidden="false",this.contents.textContent=e}unexpectedResponse(e){this.setError(`Could not ${e} because the server sent an unexpected response.`)}},k=class{input;error;constructor(e,r){this.input=h(`${e}${r}/input`,HTMLInputElement),this.error=h(`${e}${r}/error`,HTMLElement),this.input.addEventListener("input",()=>{this.input.setCustomValidity("")})}getValue(){return this.input.type==="checkbox"?this.input.checked?"checked":"unchecked":this.input.value}lock(){this.input.disabled=!0}unlock(){this.input.disabled=!1}clearError(){this.input.setCustomValidity(""),this.error.classList.add("hidden"),this.error.ariaHidden="true",this.error.textContent="!"}addError(e){if(this.error.textContent==="!"){this.setError(`Invalid value: ${e}`);return}this.error.textContent+=`, ${e}`,this.input.setCustomValidity(this.error.textContent??"Invalid value")}setError(e){this.input.setCustomValidity(e),this.error.classList.remove("hidden"),this.error.ariaHidden="false",this.error.textContent=e}},w=class{form;formError;submitButton;inputs;constructor(e,r){this.form=h(e,HTMLFormElement),this.formError=new g(e),this.submitButton=h(`${e}/submit`,HTMLButtonElement);let n=new Map;for(let o of r)n.set(o,new k(e,o));this.inputs=n}clearErrors(){this.formError.clearError();for(let e of this.inputs.values())e.clearError()}lock(){this.submitButton.disabled=!0;for(let e of this.inputs.values())e.lock()}unlock(){this.submitButton.disabled=!1;for(let e of this.inputs.values())e.unlock()}setInputErrors(e){if(!e||e.length===0){this.formError.addError("an unknown field is invalid");return}for(let r of e){let n=null;r.pointer&&(n=this.inputs.get(r.pointer)??null),n&&r.detail?n.addError(r.detail):n&&!r.detail?n.addError("unknown reason"):!n&&r.detail?this.formError.addError(r.detail):this.formError.addError("an unknown field is invalid")}}getValues(){let e=new Map;for(let[r,n]of this.inputs)e.set(r,n.getValue());return e}};function h(t,e){let r=document.getElementById(t);if(!r||!(r instanceof e))throw`element '${t}' does not exist`;return r}var l="http://localhost:8081",d=["X-TS-API-Key","identity-site"],y={deleteTokenEndpoint:l+"/tokens/current",loginHref:"/login",additionalHeaders:[d]};async function C(t){let e=await new a("GET",l+"/tokens/current").setHeaders([d]).fetch(),r=null;if(e.status==="serverError"||e.status==="clientError"){console.error(`recieved unexpected response from server when fetching current token: ${e.status}`);return}switch(e.status==="unauthorized"&&localStorage.removeItem(f),e.status==="ok"&&(r=e.body),t){case"common":return await P(r);case"provisioning":return await U(r);case"none":return await $(r)}}async function P(t){if(!t){let e=encodeURI(location.href);return await i(`/login?redirect=${e}`)}switch(t.typ){case"common":return;case"provisioning":{let e=encodeURI(location.href);return await i(`/add-first-passkey?redirect=${e}`)}default:return await m(y,!0)}}async function U(t){if(!t)return await i("/register");switch(t.typ){case"provisioning":return;case"common":{let r=new URLSearchParams(document.location.search).get("redirect"),n=r?decodeURI(r):"/identity";return await i(n)}default:return await m(y,!1)}}async function $(t){if(t)switch(t.typ){case"common":{let r=new URLSearchParams(document.location.search).get("redirect"),n=r?decodeURI(r):"/identity";return await i(n)}case"provisioning":return await i("/add-first-passkey");default:return await m(y,!1)}}await C("none");var s=new w("/login",["/username"]);document.getElementById("prompt-resident-key").addEventListener("mouseup",async()=>{s.clearErrors();let t=await I(null);if(console.log(t),!t){s.formError.unexpectedResponse("get credential request options");return}let e=await navigator.credentials.get({publicKey:t}).catch(()=>null);if(!e||!(e instanceof PublicKeyCredential)||!(e.response instanceof AuthenticatorAssertionResponse)){s.formError.setError("Could not login because the prompt was cancelled.");return}await R(e)==="clientError"?s.formError.setError("Invalid credential."):s.formError.unexpectedResponse("login")});s.form.addEventListener("submit",async t=>{try{t.preventDefault(),s.lock(),s.clearErrors();let r=s.getValues().get("/username")??"",n=await I(r);if(console.log(n),!n){s.formError.unexpectedResponse("get credential request options"),s.unlock();return}let o=await navigator.credentials.get({publicKey:n}).catch(()=>null);if(!o||!(o instanceof PublicKeyCredential)||!(o.response instanceof AuthenticatorAssertionResponse)){s.formError.setError("Could not login because the prompt was cancelled."),s.unlock();return}await R(o)==="clientError"?s.formError.setError("Invalid credential."):s.formError.unexpectedResponse("login")}finally{s.unlock()}});async function I(t){let e=await new a("GET",l+"/credential-request-options").setHeaders([d]).fetch();if(e.status!=="ok")return null;let r=e.body,n=await new a("POST",l+"/challenges").setHeaders([d]).setBody({identityId:null}).fetch();if(n.status!=="ok")return null;if(r.challenge=n.body.challenge,t){let o=await new a("GET",l+`/allowed-credentials/${t}`).setHeaders([d]).fetch();if(o.status!=="ok")return null;r.allowCredentials=o.body.allowCredentials}return PublicKeyCredential.parseRequestOptionsFromJSON(r)}async function R(t){if(!(t.response instanceof AuthenticatorAssertionResponse))return"clientError";let e=await new a("POST",l+"/tokens").setHeaders([d]).setBody({credential:{id:t.id,authenticatorAttachment:t.authenticatorAttachment,rawId:p(new Uint8Array(t.rawId)),response:{authenticatorData:p(new Uint8Array(t.response.authenticatorData)),clientDataJSON:p(new Uint8Array(t.response.clientDataJSON)),signature:p(new Uint8Array(t.response.signature)),userHandle:t.response.userHandle?p(new Uint8Array(t.response.userHandle)):null}},typ:"common"}).fetch();if(e.status==="ok"){let n=new URLSearchParams(document.location.search).get("redirect"),o=n?decodeURI(n):"/identity";return await i(o)}return e.status==="serverError"?"serverError":"clientError"}
