var b=class{element;contents;action;constructor(t,s){this.element=y(`${t}/error`,HTMLElement),this.contents=y(`${t}/error/content`,HTMLElement),this.action=s}clearError(){this.element.classList.add("collapse"),this.element.ariaHidden="true",this.contents.textContent=""}addError(t){if(this.contents.textContent===""){this.element.classList.remove("collapse"),this.element.ariaHidden="false",this.contents.textContent=`Could not ${this.action}: ${t}`;return}this.contents.textContent+=`, ${t}`}panic(){this.element.classList.remove("collapse"),this.element.ariaHidden="false",this.contents.textContent=`Something went wrong while trying to ${this.action}. Try again later.`}},E=class{input;error;constructor(t,s){this.input=y(`${t}${s}/input`,HTMLInputElement),this.error=y(`${t}${s}/error`,HTMLElement),this.input.addEventListener("input",()=>{this.input.setCustomValidity("")})}getValue(){return this.input.type==="checkbox"?this.input.checked?"checked":"unchecked":this.input.value}setLock(t){this.input.disabled=t}clearError(){this.input.setCustomValidity(""),this.error.classList.add("hidden"),this.error.ariaHidden="true",this.error.textContent="!"}addError(t){if(this.error.textContent==="!"){this.input.setCustomValidity(t),this.error.classList.remove("hidden"),this.error.ariaHidden="false",this.error.textContent=`Invalid value: ${t}`;return}this.error.textContent+=`, ${t}`,this.input.setCustomValidity(this.error.textContent??"Invalid value")}},k=class{form;formError;submitButton;inputs;constructor(t,s,n){this.form=y(t,HTMLFormElement),this.formError=new b(t,n),this.submitButton=y(`${t}/submit`,HTMLButtonElement);let r=new Map;for(let a of s)r.set(a,new E(t,a));this.inputs=r}clearErrors(){this.formError.clearError();for(let t of this.inputs.values())t.clearError()}setLock(t){this.submitButton.disabled=t;for(let s of this.inputs.values())s.setLock(t)}setInputErrors(t){if(!t||t.length===0){this.formError.addError("an unknown field is invalid");return}for(let s of t){let n=this.inputs.get(s.pointer)??null;n?n.addError(s.detail):this.formError.addError(`field ${s.pointer} ${s.detail}`)}}getValues(){let t=new Map;for(let[s,n]of this.inputs)t.set(s,n.getValue());return t}};function y(e,t){let s=document.getElementById(e);if(!s||!(s instanceof t))throw`element '${e}' does not exist`;return s}async function f(e){return location.href=e,await H()}function H(){let e=t=>{setTimeout(()=>e(t),400)};return new Promise(e)}function P(e){return Uint8Array.fromBase64(e,{alphabet:"base64url",lastChunkHandling:"loose"})}function m(e){return e.toBase64({alphabet:"base64url",omitPadding:!0})}var h="token",u=class{#t;#e;#s=null;#n=null;constructor(t,s){this.#t=t,this.#e=s}setBody(t){return this.#n=t,this}setHeaders(t){return this.#s=t,this}async fetch(){return await v(this.#t,this.#e,this.#s,this.#n)}};async function v(e,t,s,n){let r=new Headers;if(s)for(let i of s)r.append(i[0],i[1]);n&&r.append("content-type","application/json");let a=localStorage.getItem(h);a&&!r.has("Authorization")&&r.append("Authorization",a);let c=null;n&&(c=JSON.stringify(n));let o=await self.fetch(t,{method:e,body:c,headers:r}).catch(i=>(console.warn(i),new Response(null,{status:500})));if(o.ok){let i=o.headers.get("Authorization");return i&&localStorage.setItem(h,i),{status:"ok",body:await o.json().catch(w=>(console.warn(w),{}))}}switch(o.status){case 400:return{status:"badRequest",problems:(await o.json().catch(g=>(console.warn(g),{problems:[]}))).problems??[]};case 401:case 403:return{status:"unauthenticated"}}return{status:"error"}}var l="http://localhost:8081",d=["X-TS-API-Key","identity-site"];function x(){let e=localStorage.getItem(h);if(!e)return null;let t=e.split(".");if(t.length!==3)return localStorage.removeItem(h),null;let s=new TextDecoder,n=JSON.parse(s.decode(P(t[1])));return{bearer:e,act:n.act??null,exp:n.exp,sub:n.sub,typ:n.typ,tid:n.tid}}async function C(e){localStorage.getItem(h)&&(await new u("POST",l+"/revoked-tokens").setHeaders([d]).fetch(),alert("Your session has expired")),localStorage.removeItem(h);let s=e?`/login?redirect=${encodeURI(location.href)}`:"/login";return await f(s)}async function A(e,t,s){let n=await L(e.sub);if(n.status!=="ok")return n;let r=await I();if(r.status!=="ok")return r;let a=await T(e.sub,null);if(a.status!=="ok")return a;let c=await O(e);if(c.status!=="ok")return c;let o=await $();if(o.status!=="ok")return o;let i={challenge:n.data,excludeCredentials:a.data,hints:["security-key","hybrid","client-device"],rp:r.data,pubKeyCredParams:o.data,user:{displayName:c.data.displayName,id:c.data.id,name:c.data.username},authenticatorSelection:{residentKey:t?"preferred":"discouraged",userVerification:"preferred"}},g=PublicKeyCredential.parseCreationOptionsFromJSON(i),w=await navigator.credentials.create({publicKey:g}).catch(()=>null);return w?w instanceof PublicKeyCredential?await S(w,s):{status:"error"}:{status:"cancelled"}}async function I(){let e=await new u("GET",l+"/.well-known/relying-party.json").setHeaders([d]).fetch();return e.status==="ok"?{status:"ok",data:e.body}:e.status==="unauthenticated"?{status:"unauthenticated"}:{status:"error"}}async function T(e,t){let s="";e?s=`?identityId=${e}`:t&&(s=`?username=${t}`);let n=await new u("GET",l+`/existing-credentials${s}`).setHeaders([d]).fetch();return n.status==="ok"?{status:"ok",data:n.body.credentials}:n.status==="unauthenticated"?{status:"unauthenticated"}:{status:"error"}}async function L(e){let t=await new u("POST",l+"/challenges").setBody({identityId:e}).setHeaders([d]).fetch();return t.status==="ok"?{status:"ok",data:t.body.challenge}:t.status==="unauthenticated"?{status:"unauthenticated"}:{status:"error"}}async function S(e,t){if(!(e.response instanceof AuthenticatorAttestationResponse))return{status:"error"};let s=e.response.getPublicKey();if(!s)return{status:"error"};let n=await new u("POST",l+"/public-keys").setHeaders([d]).setBody({displayName:t,credential:{authenticatorAttachment:e.authenticatorAttachment,id:e.id,rawId:m(new Uint8Array(e.rawId)),response:{attestationObject:m(new Uint8Array(e.response.attestationObject)),clientDataJSON:m(new Uint8Array(e.response.clientDataJSON)),authenticatorData:m(new Uint8Array(e.response.getAuthenticatorData())),publicKey:m(new Uint8Array(s)),publicKeyAlgorithm:e.response.getPublicKeyAlgorithm(),transports:e.response.getTransports()}}}).fetch();return n.status==="ok"?{status:"ok",data:{}}:n.status==="unauthenticated"?{status:"unauthenticated"}:{status:"error"}}async function O(e){let t=await new u("GET",l+`/identities/${e.sub}`).setHeaders([d]).fetch();return t.status==="ok"?{status:"ok",data:t.body}:t.status==="unauthenticated"?{status:"unauthenticated"}:{status:"error"}}async function $(){let e=await new u("GET",l+"/.well-known/public-key-parameters.json").setHeaders([d]).fetch();return e.status==="ok"?{status:"ok",data:e.body.publicKeyParameters}:e.status==="unauthenticated"?{status:"unauthenticated"}:{status:"error"}}var K=x();if(!K)throw await f("/login"),new Error;document.getElementById("cancel")?.addEventListener("mouseup",async e=>{e.preventDefault(),K.typ==="provisioning"?await C(!1):await f("/identity")});var p=new k("/addPasskey",["/displayName","/residentKey"],"register a passkey");p.form.addEventListener("submit",async e=>{e.preventDefault();try{p.setLock(!0),p.clearErrors();let t=p.getValues(),s=t.get("/displayName")??"",n=t.get("/residentKey")??"unchecked",r=x();if(!r)throw await f("/login"),new Error;let a=await A(r,n==="checked",s);if(a.status==="ok"){let o=new URLSearchParams(document.location.search).get("redirect"),i=o?decodeURI(o):"/identity";await f(i)}else if(a.status==="cancelled"){p.formError.addError("the prompt was cancelled"),p.setLock(!1);return}else if(a.status==="unauthenticated")await C(!1);else{p.formError.panic(),p.setLock(!1);return}}finally{p.setLock(!1)}});
//# sourceMappingURL=index.js.map
