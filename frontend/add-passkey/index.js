var E=class{element;contents;action;constructor(e,n){this.element=h(`${e}/error`,HTMLElement),this.contents=h(`${e}/error/content`,HTMLElement),this.action=n}clearError(){this.element.classList.add("collapse"),this.element.ariaHidden="true",this.contents.textContent=""}addError(e){if(this.contents.textContent===""){this.element.classList.remove("collapse"),this.element.ariaHidden="false",this.contents.textContent=`Could not ${this.action}: ${e}`;return}this.contents.textContent+=`, ${e}`}panic(){this.element.classList.remove("collapse"),this.element.ariaHidden="false",this.contents.textContent=`Something went wrong while trying to ${this.action}. Try again later.`}},x=class{input;error;constructor(e,n){this.input=h(`${e}${n}/input`,HTMLInputElement),this.error=h(`${e}${n}/error`,HTMLElement),this.input.addEventListener("input",()=>{this.input.setCustomValidity("")})}getValue(){return this.input.type==="checkbox"?this.input.checked?"checked":"unchecked":this.input.value}setLock(e){this.input.disabled=e}clearError(){this.input.setCustomValidity(""),this.error.classList.add("hidden"),this.error.ariaHidden="true",this.error.textContent="!"}addError(e){if(this.error.textContent==="!"){this.input.setCustomValidity(e),this.error.classList.remove("hidden"),this.error.ariaHidden="false",this.error.textContent=`Invalid value: ${e}`;return}this.error.textContent+=`, ${e}`,this.input.setCustomValidity(this.error.textContent??"Invalid value")}},g=class{form;formError;submitButton;inputs;constructor(e,n,s){this.form=h(e,HTMLFormElement),this.formError=new E(e,s),this.submitButton=h(`${e}/submit`,HTMLButtonElement);let r=new Map;for(let a of n)r.set(a,new x(e,a));this.inputs=r}clearErrors(){this.formError.clearError();for(let e of this.inputs.values())e.clearError()}setLock(e){this.submitButton.disabled=e;for(let n of this.inputs.values())n.setLock(e)}setInputErrors(e){if(!e||e.length===0){this.formError.addError("an unknown field is invalid");return}for(let n of e){let s=this.inputs.get(n.pointer)??null;s?s.addError(n.detail):this.formError.addError(`field ${n.pointer} ${n.detail}`)}}getValues(){let e=new Map;for(let[n,s]of this.inputs)e.set(n,s.getValue());return e}};function h(t,e){let n=document.getElementById(t);if(!n||!(n instanceof e))throw`element '${t}' does not exist`;return n}async function p(t){return location.href=t,await O()}function O(){let t=e=>{setTimeout(()=>t(e),400)};return new Promise(t)}function A(t){return Uint8Array.fromBase64(t,{alphabet:"base64url",lastChunkHandling:"loose"})}function y(t){return t.toBase64({alphabet:"base64url",omitPadding:!0})}var k="ts_token",u=class{#t;#e;#n=null;#s=null;constructor(e,n){this.#t=e,this.#e=n}setBody(e){return this.#s=e,this}setHeaders(e){return this.#n=e,this}async fetch(){return await I(this.#t,this.#e,this.#n,this.#s)}};function v(t){Object.defineProperty(globalThis,"tokenDomain",{value:t,writable:!0,configurable:!0})}async function C(){let t=await globalThis.window.cookieStore.get(k);if(!t)return null;let e=t.value.split(".");if(e.length!==3)return await T(),null;let n=new TextDecoder,s=JSON.parse(n.decode(A(e[1])));return{bearer:t.value,claims:s}}async function T(){console.info("deleting token"),await globalThis.window.cookieStore.delete(k)}async function S(t){if(globalThis.tokenDomain==null||globalThis.tokenDomain==null)throw new Error("`globalThis.tokenDomain` has not been set, token cannot be saved.");console.info("setting token"),await globalThis.window.cookieStore.set({domain:globalThis.tokenDomain,name:k,value:t,sameSite:"strict",expires:Date.now()+1e3*60*60*24*30,partitioned:void 0,path:void 0})}async function I(t,e,n,s){let r=new Headers;if(n)for(let i of n)r.append(i[0],i[1]);s&&r.append("content-type","application/json");let a=await C();a&&!r.has("Authorization")&&r.append("Authorization",a.bearer);let c=null;s&&(c=JSON.stringify(s));let o=await self.fetch(e,{method:t,body:c,headers:r}).catch(i=>(console.warn(i),new Response(null,{status:500})));if(o.ok){let i=o.headers.get("Authorization");return i&&await S(i),{status:"ok",body:await o.json().catch(m=>(console.warn(m),{}))}}switch(o.status){case 400:return{status:"badRequest",problems:(await o.json().catch(w=>(console.warn(w),{problems:[]}))).problems??[]};case 401:case 403:return{status:"unauthenticated"}}return{status:"error"}}var l="http://localhost:8081",d=["X-TS-API-Key","identity-site"];function K(){v("")}async function b(){let t=await C();return t?{bearer:t.bearer,act:t.claims.act??null,exp:t.claims.exp,sub:t.claims.sub,typ:t.claims.typ,tid:t.claims.tid}:null}async function P(t){await b()&&(await new u("POST",l+"/revoked-tokens").setHeaders([d]).fetch(),alert("Your session has expired")),await T();let n=t?`/login?redirect=${encodeURI(location.href)}`:"/login";return await p(n)}async function H(t,e,n){let s=await U(t.sub);if(s.status!=="ok")return s;let r=await $();if(r.status!=="ok")return r;let a=await D(t.sub,null);if(a.status!=="ok")return a;let c=await B(t);if(c.status!=="ok")return c;let o=await R();if(o.status!=="ok")return o;let i={challenge:s.data,excludeCredentials:a.data,hints:["security-key","hybrid","client-device"],rp:r.data,pubKeyCredParams:o.data,user:{displayName:c.data.displayName,id:c.data.id,name:c.data.username},authenticatorSelection:{residentKey:e?"preferred":"discouraged",userVerification:"preferred"}},w=PublicKeyCredential.parseCreationOptionsFromJSON(i),m=await navigator.credentials.create({publicKey:w}).catch(()=>null);return m?m instanceof PublicKeyCredential?await N(m,n):{status:"error"}:{status:"cancelled"}}async function $(){let t=await new u("GET",l+"/.well-known/relying-party.json").setHeaders([d]).fetch();return t.status==="ok"?{status:"ok",data:t.body}:t.status==="unauthenticated"?{status:"unauthenticated"}:{status:"error"}}async function D(t,e){let n="";t?n=`?identityId=${t}`:e&&(n=`?username=${e}`);let s=await new u("GET",l+`/existing-credentials${n}`).setHeaders([d]).fetch();return s.status==="ok"?{status:"ok",data:s.body.credentials}:s.status==="unauthenticated"?{status:"unauthenticated"}:{status:"error"}}async function U(t){let e=await new u("POST",l+"/challenges").setBody({identityId:t}).setHeaders([d]).fetch();return e.status==="ok"?{status:"ok",data:e.body.challenge}:e.status==="unauthenticated"?{status:"unauthenticated"}:{status:"error"}}async function N(t,e){if(!(t.response instanceof AuthenticatorAttestationResponse))return{status:"error"};let n=t.response.getPublicKey();if(!n)return{status:"error"};let s=await new u("POST",l+"/public-keys").setHeaders([d]).setBody({displayName:e,credential:{authenticatorAttachment:t.authenticatorAttachment,id:t.id,rawId:y(new Uint8Array(t.rawId)),response:{attestationObject:y(new Uint8Array(t.response.attestationObject)),clientDataJSON:y(new Uint8Array(t.response.clientDataJSON)),authenticatorData:y(new Uint8Array(t.response.getAuthenticatorData())),publicKey:y(new Uint8Array(n)),publicKeyAlgorithm:t.response.getPublicKeyAlgorithm(),transports:t.response.getTransports()}}}).fetch();return s.status==="ok"?{status:"ok",data:{}}:s.status==="unauthenticated"?{status:"unauthenticated"}:{status:"error"}}async function B(t){let e=await new u("GET",l+`/identities/${t.sub}`).setHeaders([d]).fetch();return e.status==="ok"?{status:"ok",data:e.body}:e.status==="unauthenticated"?{status:"unauthenticated"}:{status:"error"}}async function R(){let t=await new u("GET",l+"/.well-known/public-key-parameters.json").setHeaders([d]).fetch();return t.status==="ok"?{status:"ok",data:t.body.publicKeyParameters}:t.status==="unauthenticated"?{status:"unauthenticated"}:{status:"error"}}K();var L=await b();if(!L)throw await p("/login"),new Error;document.getElementById("cancel")?.addEventListener("mouseup",async t=>{t.preventDefault(),L.typ==="provisioning"?await P(!1):await p("/identity")});var f=new g("/addPasskey",["/displayName","/residentKey"],"register a passkey");f.form.addEventListener("submit",async t=>{t.preventDefault();try{f.setLock(!0),f.clearErrors();let e=f.getValues(),n=e.get("/displayName")??"",s=e.get("/residentKey")??"unchecked",r=await b();if(!r)throw await p("/login"),new Error;let a=await H(r,s==="checked",n);if(a.status==="ok"){let o=new URLSearchParams(document.location.search).get("redirect"),i=o?decodeURI(o):"/identity";await p(i)}else if(a.status==="cancelled"){f.formError.addError("the prompt was cancelled"),f.setLock(!1);return}else if(a.status==="unauthenticated")await P(!1);else{f.formError.panic(),f.setLock(!1);return}}finally{f.setLock(!1)}});
//# sourceMappingURL=index.js.map
