function f(e){return e.toBase64({alphabet:"base64url",omitPadding:!0})}async function m(e){return location.href=e,await P()}function P(){let e=t=>{setTimeout(()=>e(t),400)};return new Promise(e)}var h="token",l=class{#t;#e;#r=null;#n=null;#s=null;#o=!1;constructor(t,r){this.#t=t,this.#e=r}setBody(t){return this.#n=t,this}setHeaders(t){return this.#r=t,this}setLogout(t,r){return this.#s=t,this.#o=r,this}async fetch(){return await $(this.#t,this.#e,this.#r,this.#n,this.#s,this.#o)}};async function $(e,t,r,s,c,x){let u=new Headers;if(r)for(let n of r)u.append(n[0],n[1]);s&&u.append("content-type","application/json");let g=localStorage.getItem(h);g&&!u.has("Authorization")&&u.append("Authorization",g);let a=null;s&&(a=JSON.stringify(s));let i=await self.fetch(t,{method:e,body:a,headers:u}).catch(n=>(console.warn(n),new Response(null,{status:500})));if(i.ok){let n=i.headers.get("Authorization");return n&&localStorage.setItem(h,n),{status:"ok",body:await i.json().catch(k=>(console.warn(k),{}))}}else return i.status===401?(c&&await H(c,x),{status:"unauthorized"}):i.status===404?{status:"notFound"}:i.status>=400&&i.status<500?{status:"clientError",problems:(await i.json().catch(b=>(console.warn(b),{problems:[]}))).problems??[]}:{status:"serverError"}}async function H(e,t){let r=localStorage.getItem(h);await new l("DELETE",e.deleteTokenEndpoint).setHeaders(e.additionalHeaders).fetch(),localStorage.removeItem(h),r&&alert("Your session has expired");let s=t?`${e.loginHref}?redirect=${encodeURI(location.href)}`:e.loginHref;return await m(s)}var C=class{element;contents;constructor(t){this.element=y(`${t}/error`,HTMLElement),this.contents=y(`${t}/error/content`,HTMLElement)}clearError(){this.element.classList.add("collapse"),this.element.ariaHidden="true",this.contents.textContent=""}addError(t){if(this.contents.textContent===""){this.setError(`Invalid form: ${t}`);return}this.contents.textContent+=`, ${t}`}setError(t){this.element.classList.remove("collapse"),this.element.ariaHidden="false",this.contents.textContent=t}unexpectedResponse(t){this.setError(`Could not ${t} because the server sent an unexpected response.`)}},L=class{input;error;constructor(t,r){this.input=y(`${t}${r}/input`,HTMLInputElement),this.error=y(`${t}${r}/error`,HTMLElement),this.input.addEventListener("input",()=>{this.input.setCustomValidity("")})}getValue(){return this.input.type==="checkbox"?this.input.checked?"checked":"unchecked":this.input.value}lock(){this.input.disabled=!0}unlock(){this.input.disabled=!1}clearError(){this.input.setCustomValidity(""),this.error.classList.add("hidden"),this.error.ariaHidden="true",this.error.textContent="!"}addError(t){if(this.error.textContent==="!"){this.setError(`Invalid value: ${t}`);return}this.error.textContent+=`, ${t}`,this.input.setCustomValidity(this.error.textContent??"Invalid value")}setError(t){this.input.setCustomValidity(t),this.error.classList.remove("hidden"),this.error.ariaHidden="false",this.error.textContent=t}},w=class{form;formError;submitButton;inputs;constructor(t,r){this.form=y(t,HTMLFormElement),this.formError=new C(t),this.submitButton=y(`${t}/submit`,HTMLButtonElement);let s=new Map;for(let c of r)s.set(c,new L(t,c));this.inputs=s}clearErrors(){this.formError.clearError();for(let t of this.inputs.values())t.clearError()}lock(){this.submitButton.disabled=!0;for(let t of this.inputs.values())t.lock()}unlock(){this.submitButton.disabled=!1;for(let t of this.inputs.values())t.unlock()}setInputErrors(t){if(!t||t.length===0){this.formError.addError("an unknown field is invalid");return}for(let r of t){let s=null;r.pointer&&(s=this.inputs.get(r.pointer)??null),s&&r.detail?s.addError(r.detail):s&&!r.detail?s.addError("unknown reason"):!s&&r.detail?this.formError.addError(r.detail):this.formError.addError("an unknown field is invalid")}}getValues(){let t=new Map;for(let[r,s]of this.inputs)t.set(r,s.getValue());return t}};function y(e,t){let r=document.getElementById(e);if(!r||!(r instanceof t))throw`element '${e}' does not exist`;return r}var d="http://localhost:8081",p=["X-TS-API-Key","identity-site"],E={deleteTokenEndpoint:d+"/tokens/current",loginHref:"/login",additionalHeaders:[p]};async function I(){let e=await new l("GET",d+"/tokens/current").setHeaders([p]).fetch();return e.status==="serverError"||e.status==="clientError"||e.status==="unauthorized"?(localStorage.removeItem(h),null):e.status==="ok"?e.body:(localStorage.removeItem(h),null)}var T=await I();if(!T)throw await m("/login"),new Error;document.getElementById("cancel")?.addEventListener("mouseup",async e=>{e.preventDefault(),T.typ==="provisioning"?await H(E,!1):await m("/identity")});var o=new w("/addPasskey",["/displayName","/residentKey"]);o.form.addEventListener("submit",async e=>{e.preventDefault();try{o.lock(),o.clearErrors();let t=o.getValues(),r=t.get("/displayName")??"",s=t.get("/residentKey")??"unchecked",c=await new l("GET",d+"/tokens/current").setHeaders([p]).setLogout(E,!1).fetch();if(c.status!=="ok"){o.formError.unexpectedResponse("register a passkey"),o.unlock();return}let x=c.body,u=await new l("POST",d+"/challenges").setLogout(E,!1).setHeaders([p]).setBody({identityId:x.sub}).fetch();if(u.status!=="ok"){o.formError.unexpectedResponse("register a passkey"),o.unlock();return}let g=u.body.challenge,a=await new l("GET",d+"/credential-creation-options").setHeaders([p]).setLogout(E,!1).fetch();if(a.status!=="ok"){o.formError.unexpectedResponse("register a passkey"),o.unlock();return}a.body.challenge=g,s==="checked"&&a.body.authenticatorSelection?a.body.authenticatorSelection.residentKey="preferred":a.body.authenticatorSelection&&(a.body.authenticatorSelection.residentKey="discouraged");let i=PublicKeyCredential.parseCreationOptionsFromJSON(a.body);console.log(i);let n=await navigator.credentials.create({publicKey:i}).catch(()=>null);if(!n||!(n instanceof PublicKeyCredential)||!(n.response instanceof AuthenticatorAttestationResponse)){o.formError.setError("Could not register a passkey because the prompt was cancelled."),o.unlock();return}let b=n.response.getAuthenticatorData(),k=n.response.getPublicKey(),K=n.response.getPublicKeyAlgorithm(),R=n.response.getTransports();if(!k){o.formError.setError("Could not register the passkey because it wasn't created."),o.unlock();return}let O={attestationObject:f(new Uint8Array(n.response.attestationObject)),clientDataJSON:f(new Uint8Array(n.response.clientDataJSON)),authenticatorData:f(new Uint8Array(b)),publicKey:f(new Uint8Array(k)),publicKeyAlgorithm:K,transports:R},v=await new l("POST",d+"/public-keys").setLogout(E,!1).setHeaders([p]).setBody({displayName:r,credential:{authenticatorAttachment:n.authenticatorAttachment,id:n.id,rawId:f(new Uint8Array(n.rawId)),response:O}}).fetch();if(v.status==="ok"){let A=new URLSearchParams(document.location.search).get("redirect"),S=A?decodeURI(A):"/identity";await m(S)}else v.status==="clientError"?o.setInputErrors(v.problems):o.formError.unexpectedResponse("register the passkey")}finally{o.unlock()}});
//# sourceMappingURL=index.js.map
