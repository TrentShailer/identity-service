// deno-lint-ignore-file
// deno-fmt-ignore-file
// @ts-nocheck
function m(r){return r.toBase64({alphabet:"base64url",omitPadding:!0})}async function i(r){return location.href=r,await O()}function O(){let r=t=>{setTimeout(()=>r(t),400)};return new Promise(r)}var w="token",c=class{#t;#e;#r=null;#s=null;#n=null;#o=!1;constructor(t,e){this.#t=t,this.#e=e}setBody(t){return this.#s=t,this}setHeaders(t){return this.#r=t,this}setLogout(t,e){return this.#n=t,this.#o=e,this}async fetch(){return await U(this.#t,this.#e,this.#r,this.#s,this.#n,this.#o)}};async function U(r,t,e,s,p,b){let h=new Headers;if(e)for(let a of e)h.append(a[0],a[1]);s&&h.append("content-type","application/json");let f=localStorage.getItem(w);f&&h.append("Authorization",f);let k=null;s&&(k=JSON.stringify(s));let n=await self.fetch(t,{method:r,body:k,headers:h}).catch(a=>(console.warn(a),new Response(null,{status:500})));if(n.ok){let a=n.headers.get("Authorization");return a&&localStorage.setItem(w,a),{status:"ok",body:await n.json().catch(v=>(console.warn(v),{}))}}else return n.status===401?(p&&await g(p,b),{status:"unauthorized"}):n.status===404?{status:"notFound"}:n.status>=400&&n.status<500?{status:"clientError",problems:(await n.json().catch(E=>(console.warn(E),{problems:[]}))).problems??[]}:{status:"serverError"}}async function g(r,t){let e=localStorage.getItem(w);await new c("DELETE",r.deleteTokenEndpoint).setHeaders(r.additionalHeaders).fetch(),localStorage.removeItem(w),e&&alert("Your session has expired");let s=t?`${r.loginHref}?redirect=${encodeURI(location.href)}`:r.loginHref;return await i(s)}var H=class{element;contents;constructor(t){this.element=y(`${t}/error`,HTMLElement),this.contents=y(`${t}/error/content`,HTMLElement)}clearError(){this.element.classList.add("collapse"),this.element.ariaHidden="true",this.contents.textContent=""}addError(t){if(this.contents.textContent===""){this.setError(`Invalid form: ${t}`);return}this.contents.textContent+=`, ${t}`}setError(t){this.element.classList.remove("collapse"),this.element.ariaHidden="false",this.contents.textContent=t}unexpectedResponse(t){this.setError(`Could not ${t} because the server sent an unexpected response.`)}},C=class{input;error;constructor(t,e){this.input=y(`${t}${e}/input`,HTMLInputElement),this.error=y(`${t}${e}/error`,HTMLElement),this.input.addEventListener("input",()=>{this.input.setCustomValidity("")})}getValue(){return this.input.value}lock(){this.input.disabled=!0}unlock(){this.input.disabled=!1}clearError(){this.input.setCustomValidity(""),this.error.classList.add("hidden"),this.error.ariaHidden="true",this.error.textContent="!"}addError(t){if(this.error.textContent==="!"){this.setError(`Invalid value: ${t}`);return}this.error.textContent+=`, ${t}`,this.input.setCustomValidity(this.error.textContent??"Invalid value")}setError(t){this.input.setCustomValidity(t),this.error.classList.remove("hidden"),this.error.ariaHidden="false",this.error.textContent=t}},x=class{form;formError;submitButton;inputs;constructor(t,e){this.form=y(t,HTMLFormElement),this.formError=new H(t),this.submitButton=y(`${t}/submit`,HTMLButtonElement);let s=new Map;for(let p of e)s.set(p,new C(t,p));this.inputs=s}clearErrors(){this.formError.clearError();for(let t of this.inputs.values())t.clearError()}lock(){this.submitButton.disabled=!0;for(let t of this.inputs.values())t.lock()}unlock(){this.submitButton.disabled=!1;for(let t of this.inputs.values())t.unlock()}setInputErrors(t){if(!t||t.length===0){this.formError.addError("an unknown field is invalid");return}for(let e of t){let s=null;e.pointer&&(s=this.inputs.get(e.pointer)??null),s&&e.detail?s.addError(e.detail):s&&!e.detail?s.addError("unknown reason"):!s&&e.detail?this.formError.addError(e.detail):this.formError.addError("an unknown field is invalid")}}getValues(){let t=new Map;for(let[e,s]of this.inputs)t.set(e,s.getValue());return t}};function y(r,t){let e=document.getElementById(r);if(!e||!(e instanceof t))throw`element '${r}' does not exist`;return e}var l="http://localhost:8081",d=["X-TS-API-Key","identity-site"],u={deleteTokenEndpoint:l+"/tokens/current",loginHref:"/login",additionalHeaders:[d]};async function I(r){let t=await new c("GET",l+"/tokens/current").setHeaders([d]).fetch(),e=null;if(t.status==="serverError"||t.status==="clientError"){console.error(`recieved unexpected response from server when fetching current token: ${t.status}`);return}switch(t.status==="unauthorized"&&localStorage.removeItem(w),t.status==="ok"&&(e=t.body),r){case"common":return await $(e);case"provisioning":return await K(e);case"none":return await S(e)}}async function $(r){if(!r){let t=encodeURI(location.href);return await i(`/login?redirect=${t}`)}switch(r.typ){case"common":return;case"provisioning":{let t=encodeURI(location.href);return await i(`/add-first-passkey?redirect=${t}`)}default:return await g(u,!0)}}async function K(r){if(!r)return await i("/register");switch(r.typ){case"provisioning":return;case"common":{let e=new URLSearchParams(document.location.search).get("redirect"),s=e?decodeURI(e):"/identity";return await i(s)}default:return await g(u,!1)}}async function S(r){if(r)switch(r.typ){case"common":{let e=new URLSearchParams(document.location.search).get("redirect"),s=e?decodeURI(e):"/identity";return await i(s)}case"provisioning":return await i("/add-first-passkey");default:return await g(u,!1)}}await I("provisioning");var o=new x("/addPasskey",["/displayName"]);o.form.addEventListener("submit",async r=>{r.preventDefault();try{o.lock(),o.clearErrors();let e=o.getValues().get("/displayName")??"",s=await new c("GET",l+"/tokens/current").setHeaders([d]).setLogout(u,!1).fetch();if(s.status!=="ok")throw o.formError.unexpectedResponse("register a passkey"),"";let p=s.body,b=await new c("POST",l+"/challenges").setLogout(u,!1).setHeaders([d]).setBody({identityId:p.sub}).fetch();if(b.status!=="ok")throw o.formError.unexpectedResponse("register a passkey"),"";let h=b.body.challenge,f=await new c("GET",l+"/credential-creation-options").setHeaders([d]).setLogout(u,!1).fetch();if(f.status!=="ok")throw o.formError.unexpectedResponse("register a passkey"),"";f.body.challenge=h;let k=PublicKeyCredential.parseCreationOptionsFromJSON(f.body),n=await navigator.credentials.create({publicKey:k}).catch(()=>null);if(!n||!(n instanceof PublicKeyCredential)||!(n.response instanceof AuthenticatorAttestationResponse))throw o.formError.setError("Could not register a passkey because the prompt was cancelled."),"";let a=n.response.getAuthenticatorData(),E=n.response.getPublicKey(),v=n.response.getPublicKeyAlgorithm(),R=n.response.getTransports();if(!E)throw o.formError.setError("Could not register the passkey because it wasn't created."),"";let P={attestationObject:m(new Uint8Array(n.response.attestationObject)),clientDataJSON:m(new Uint8Array(n.response.clientDataJSON)),authenticatorData:m(new Uint8Array(a)),publicKey:m(new Uint8Array(E)),publicKeyAlgorithm:v,transports:R},T=await new c("POST",l+"/public-keys").setLogout(u,!1).setHeaders([d]).setBody({displayName:e,credential:{authenticatorAttachment:n.authenticatorAttachment,id:n.id,rawId:m(new Uint8Array(n.rawId)),response:P}}).fetch();if(T.status==="ok"){let L=new URLSearchParams(document.location.search).get("redirect"),A=L?decodeURI(L):"/identity";await i(A)}else T.status==="clientError"?o.setInputErrors(T.problems):o.formError.unexpectedResponse("register the passkey")}finally{o.unlock()}});
