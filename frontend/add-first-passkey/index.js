// deno-lint-ignore-file
// deno-fmt-ignore-file
// @ts-nocheck
function m(r){return r.toBase64({alphabet:"base64url",omitPadding:!0})}async function a(r){return location.href=r,await O()}function O(){let r=e=>{setTimeout(()=>r(e),400)};return new Promise(r)}var y="token",u=class{#e;#t;#r=null;#n=null;#s=null;#o=!1;constructor(e,t){this.#e=e,this.#t=t}setBody(e){return this.#n=e,this}setHeaders(e){return this.#r=e,this}setLogout(e,t){return this.#s=e,this.#o=t,this}async fetch(){return await U(this.#e,this.#t,this.#r,this.#n,this.#s,this.#o)}};async function U(r,e,t,n,d,v){let f=new Headers;if(t)for(let s of t)f.append(s[0],s[1]);n&&f.append("content-type","application/json");let E=localStorage.getItem(y);E&&f.append("Authorization",E);let c=null;n&&(c=JSON.stringify(n));let i=await self.fetch(e,{method:r,body:c,headers:f}).catch(s=>(console.warn(s),new Response(null,{status:500})));if(i.ok){let s=i.headers.get("Authorization");return s&&localStorage.setItem(y,s),{status:"ok",body:await i.json().catch(b=>(console.warn(b),{}))}}else return i.status===401?(d&&await g(d,v),{status:"unauthorized"}):i.status===404?{status:"notFound"}:i.status>=400&&i.status<500?{status:"clientError",problems:(await i.json().catch(k=>(console.warn(k),{problems:[]}))).problems??[]}:{status:"serverError"}}async function g(r,e){let t=localStorage.getItem(y);await new u("DELETE",r.deleteTokenEndpoint).setHeaders(r.additionalHeaders).fetch(),localStorage.removeItem(y),t&&alert("Your session has expired");let n=e?`${r.loginHref}?redirect=${encodeURI(location.href)}`:r.loginHref;return await a(n)}var H=class{element;contents;constructor(e){this.element=w(`${e}/error`,HTMLElement),this.contents=w(`${e}/error/content`,HTMLElement)}clearError(){this.element.classList.add("collapse"),this.element.ariaHidden="true",this.contents.textContent=""}addError(e){if(this.contents.textContent===""){this.setError(`Invalid form: ${e}`);return}this.contents.textContent+=`, ${e}`}setError(e){this.element.classList.remove("collapse"),this.element.ariaHidden="false",this.contents.textContent=e}unexpectedResponse(e){this.setError(`Could not ${e} because the server sent an unexpected response.`)}},C=class{input;error;constructor(e,t){this.input=w(`${e}${t}/input`,HTMLInputElement),this.error=w(`${e}${t}/error`,HTMLElement),this.input.addEventListener("input",()=>{this.input.setCustomValidity("")})}getValue(){return this.input.type==="checkbox"?this.input.checked?"checked":"unchecked":this.input.value}lock(){this.input.disabled=!0}unlock(){this.input.disabled=!1}clearError(){this.input.setCustomValidity(""),this.error.classList.add("hidden"),this.error.ariaHidden="true",this.error.textContent="!"}addError(e){if(this.error.textContent==="!"){this.setError(`Invalid value: ${e}`);return}this.error.textContent+=`, ${e}`,this.input.setCustomValidity(this.error.textContent??"Invalid value")}setError(e){this.input.setCustomValidity(e),this.error.classList.remove("hidden"),this.error.ariaHidden="false",this.error.textContent=e}},x=class{form;formError;submitButton;inputs;constructor(e,t){this.form=w(e,HTMLFormElement),this.formError=new H(e),this.submitButton=w(`${e}/submit`,HTMLButtonElement);let n=new Map;for(let d of t)n.set(d,new C(e,d));this.inputs=n}clearErrors(){this.formError.clearError();for(let e of this.inputs.values())e.clearError()}lock(){this.submitButton.disabled=!0;for(let e of this.inputs.values())e.lock()}unlock(){this.submitButton.disabled=!1;for(let e of this.inputs.values())e.unlock()}setInputErrors(e){if(!e||e.length===0){this.formError.addError("an unknown field is invalid");return}for(let t of e){let n=null;t.pointer&&(n=this.inputs.get(t.pointer)??null),n&&t.detail?n.addError(t.detail):n&&!t.detail?n.addError("unknown reason"):!n&&t.detail?this.formError.addError(t.detail):this.formError.addError("an unknown field is invalid")}}getValues(){let e=new Map;for(let[t,n]of this.inputs)e.set(t,n.getValue());return e}};function w(r,e){let t=document.getElementById(r);if(!t||!(t instanceof e))throw`element '${r}' does not exist`;return t}var p="http://localhost:8081",h=["X-TS-API-Key","identity-site"],l={deleteTokenEndpoint:p+"/tokens/current",loginHref:"/login",additionalHeaders:[h]};async function I(r){let e=await new u("GET",p+"/tokens/current").setHeaders([h]).fetch(),t=null;if(e.status==="serverError"||e.status==="clientError"){console.error(`recieved unexpected response from server when fetching current token: ${e.status}`);return}switch(e.status==="unauthorized"&&localStorage.removeItem(y),e.status==="ok"&&(t=e.body),r){case"common":return await S(t);case"provisioning":return await $(t);case"none":return await B(t)}}async function S(r){if(!r){let e=encodeURI(location.href);return await a(`/login?redirect=${e}`)}switch(r.typ){case"common":return;case"provisioning":{let e=encodeURI(location.href);return await a(`/add-first-passkey?redirect=${e}`)}default:return await g(l,!0)}}async function $(r){if(!r)return await a("/register");switch(r.typ){case"provisioning":return;case"common":{let t=new URLSearchParams(document.location.search).get("redirect"),n=t?decodeURI(t):"/identity";return await a(n)}default:return await g(l,!1)}}async function B(r){if(r)switch(r.typ){case"common":{let t=new URLSearchParams(document.location.search).get("redirect"),n=t?decodeURI(t):"/identity";return await a(n)}case"provisioning":return await a("/add-first-passkey");default:return await g(l,!1)}}await I("provisioning");var o=new x("/addPasskey",["/displayName","/residentKey"]);o.form.addEventListener("submit",async r=>{r.preventDefault();try{o.lock(),o.clearErrors();let e=o.getValues(),t=e.get("/displayName")??"",n=e.get("/residentKey")??"unchecked",d=await new u("GET",p+"/tokens/current").setHeaders([h]).setLogout(l,!1).fetch();if(d.status!=="ok"){o.formError.unexpectedResponse("register a passkey"),o.unlock();return}let v=d.body,f=await new u("POST",p+"/challenges").setLogout(l,!1).setHeaders([h]).setBody({identityId:v.sub}).fetch();if(f.status!=="ok"){o.formError.unexpectedResponse("register a passkey"),o.unlock();return}let E=f.body.challenge,c=await new u("GET",p+"/credential-creation-options").setHeaders([h]).setLogout(l,!1).fetch();if(c.status!=="ok"){o.formError.unexpectedResponse("register a passkey"),o.unlock();return}c.body.challenge=E,n==="checked"&&c.body.authenticatorSelection?c.body.authenticatorSelection.residentKey="preferred":c.body.authenticatorSelection&&(c.body.authenticatorSelection.residentKey="discouraged");let i=PublicKeyCredential.parseCreationOptionsFromJSON(c.body);console.log(i);let s=await navigator.credentials.create({publicKey:i}).catch(()=>null);if(!s||!(s instanceof PublicKeyCredential)||!(s.response instanceof AuthenticatorAttestationResponse)){o.formError.setError("Could not register a passkey because the prompt was cancelled."),o.unlock();return}let k=s.response.getAuthenticatorData(),b=s.response.getPublicKey(),R=s.response.getPublicKeyAlgorithm(),P=s.response.getTransports();if(!b){o.formError.setError("Could not register the passkey because it wasn't created."),o.unlock();return}let A={attestationObject:m(new Uint8Array(s.response.attestationObject)),clientDataJSON:m(new Uint8Array(s.response.clientDataJSON)),authenticatorData:m(new Uint8Array(k)),publicKey:m(new Uint8Array(b)),publicKeyAlgorithm:R,transports:P},T=await new u("POST",p+"/public-keys").setLogout(l,!1).setHeaders([h]).setBody({displayName:t,credential:{authenticatorAttachment:s.authenticatorAttachment,id:s.id,rawId:m(new Uint8Array(s.rawId)),response:A}}).fetch();if(T.status==="ok"){let L=new URLSearchParams(document.location.search).get("redirect"),K=L?decodeURI(L):"/identity";await a(K)}else T.status==="clientError"?o.setInputErrors(T.problems):o.formError.unexpectedResponse("register the passkey")}finally{o.unlock()}});
