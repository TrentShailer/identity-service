var f=class{element;contents;action;constructor(t,n){this.element=l(`${t}/error`,HTMLElement),this.contents=l(`${t}/error/content`,HTMLElement),this.action=n}clearError(){this.element.classList.add("collapse"),this.element.ariaHidden="true",this.contents.textContent=""}addError(t){if(this.contents.textContent===""){this.element.classList.remove("collapse"),this.element.ariaHidden="false",this.contents.textContent=`Could not ${this.action}: ${t}`;return}this.contents.textContent+=`, ${t}`}panic(){this.element.classList.remove("collapse"),this.element.ariaHidden="false",this.contents.textContent=`Something went wrong while trying to ${this.action}. Try again later.`}},m=class{input;error;constructor(t,n){this.input=l(`${t}${n}/input`,HTMLInputElement),this.error=l(`${t}${n}/error`,HTMLElement),this.input.addEventListener("input",()=>{this.input.setCustomValidity("")})}getValue(){return this.input.type==="checkbox"?this.input.checked?"checked":"unchecked":this.input.value}setLock(t){this.input.disabled=t}clearError(){this.input.setCustomValidity(""),this.error.classList.add("hidden"),this.error.ariaHidden="true",this.error.textContent="!"}addError(t){if(this.error.textContent==="!"){this.input.setCustomValidity(t),this.error.classList.remove("hidden"),this.error.ariaHidden="false",this.error.textContent=`Invalid value: ${t}`;return}this.error.textContent+=`, ${t}`,this.input.setCustomValidity(this.error.textContent??"Invalid value")}},h=class{form;formError;submitButton;inputs;constructor(t,n,o){this.form=l(t,HTMLFormElement),this.formError=new f(t,o),this.submitButton=l(`${t}/submit`,HTMLButtonElement);let s=new Map;for(let i of n)s.set(i,new m(t,i));this.inputs=s}clearErrors(){this.formError.clearError();for(let t of this.inputs.values())t.clearError()}setLock(t){this.submitButton.disabled=t;for(let n of this.inputs.values())n.setLock(t)}setInputErrors(t){if(!t||t.length===0){this.formError.addError("an unknown field is invalid");return}for(let n of t){let o=this.inputs.get(n.pointer)??null;o?o.addError(n.detail):this.formError.addError(`field ${n.pointer} ${n.detail}`)}}getValues(){let t=new Map;for(let[n,o]of this.inputs)t.set(n,o.getValue());return t}};function l(e,t){let n=document.getElementById(e);if(!n||!(n instanceof t))throw`element '${e}' does not exist`;return n}function E(e){return Uint8Array.fromBase64(e,{alphabet:"base64url",lastChunkHandling:"loose"})}var w="ts_token",u=class{#t;#e;#n=null;#o=null;constructor(t,n){this.#t=t,this.#e=n}setBody(t){return this.#o=t,this}setHeaders(t){return this.#n=t,this}async fetch(){return await P(this.#t,this.#e,this.#n,this.#o)}};function T(e){Object.defineProperty(globalThis,"tokenDomain",{value:e,writable:!0,configurable:!0})}async function g(){let e=await globalThis.window.cookieStore.get(w);if(!e)return null;let t=e.value.split(".");if(t.length!==3)return await v(),null;let n=new TextDecoder,o=JSON.parse(n.decode(E(t[1])));return{bearer:e.value,claims:o}}async function v(){console.info("deleting token"),await globalThis.window.cookieStore.delete(w)}async function $(e){if(globalThis.tokenDomain==null||globalThis.tokenDomain==null)throw new Error("`globalThis.tokenDomain` has not been set, token cannot be saved.");console.info("setting token"),await globalThis.window.cookieStore.set({domain:globalThis.tokenDomain,name:w,value:e,sameSite:"strict",expires:Date.now()+1e3*60*60*24*30,partitioned:void 0,path:void 0})}async function P(e,t,n,o){let s=new Headers;if(n)for(let r of n)s.append(r[0],r[1]);o&&s.append("content-type","application/json");let i=await g();i&&!s.has("Authorization")&&s.append("Authorization",i.bearer);let p=null;o&&(p=JSON.stringify(o));let a=await self.fetch(t,{method:e,body:p,headers:s}).catch(r=>(console.warn(r),new Response(null,{status:500})));if(a.ok){let r=a.headers.get("Authorization");return r&&await $(r),{status:"ok",body:await a.json().catch(H=>(console.warn(H),{}))}}switch(a.status){case 400:return{status:"badRequest",problems:(await a.json().catch(x=>(console.warn(x),{problems:[]}))).problems??[]};case 401:case 403:return{status:"unauthenticated"}}return{status:"error"}}var b="http://localhost:8081",k=["X-TS-API-Key","identity-site"];function C(){T("")}async function d(e){return location.href=e,await A()}function A(){let e=t=>{setTimeout(()=>e(t),400)};return new Promise(e)}async function y(){let e=await g();return e?{bearer:e.bearer,act:e.claims.act??null,exp:e.claims.exp,sub:e.claims.sub,typ:e.claims.typ,tid:e.claims.tid}:null}C();var L=await y();if(L)switch(L.typ){case"common":await d("/identity");break;case"provisioning":await d("/add-passkey");break}var c=new h("/register",["/username","/displayName"],"register");c.form.addEventListener("submit",async e=>{e.preventDefault(),c.setLock(!0),c.clearErrors();let t=c.getValues(),n=t.get("/username")??"",o=t.get("/displayName")??"",s=await new u("POST",b+"/identities").setHeaders([k]).setBody({username:n,displayName:o}).fetch(),i=await y();if(console.log(i),s.status==="ok"&&i){let a=new URLSearchParams(document.location.search).get("redirect"),r=a?`/add-passkey?redirect=${a}`:"/add-passkey";await d(r)}else s.status==="badRequest"?c.setInputErrors(s.problems):c.formError.panic();c.setLock(!1)});
//# sourceMappingURL=index.js.map
