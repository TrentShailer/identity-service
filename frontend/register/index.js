var f=class{element;contents;action;constructor(t,e){this.element=u(`${t}/error`,HTMLElement),this.contents=u(`${t}/error/content`,HTMLElement),this.action=e}clearError(){this.element.classList.add("collapse"),this.element.ariaHidden="true",this.contents.textContent=""}addError(t){if(this.contents.textContent===""){this.element.classList.remove("collapse"),this.element.ariaHidden="false",this.contents.textContent=`Could not ${this.action}: ${t}`;return}this.contents.textContent+=`, ${t}`}panic(){this.element.classList.remove("collapse"),this.element.ariaHidden="false",this.contents.textContent=`Something went wrong while trying to ${this.action}. Try again later.`}},g=class{input;error;constructor(t,e){this.input=u(`${t}${e}/input`,HTMLInputElement),this.error=u(`${t}${e}/error`,HTMLElement),this.input.addEventListener("input",()=>{this.input.setCustomValidity("")})}getValue(){return this.input.type==="checkbox"?this.input.checked?"checked":"unchecked":this.input.value}setLock(t){this.input.disabled=t}clearError(){this.input.setCustomValidity(""),this.error.classList.add("hidden"),this.error.ariaHidden="true",this.error.textContent="!"}addError(t){if(this.error.textContent==="!"){this.input.setCustomValidity(t),this.error.classList.remove("hidden"),this.error.ariaHidden="false",this.error.textContent=`Invalid value: ${t}`;return}this.error.textContent+=`, ${t}`,this.input.setCustomValidity(this.error.textContent??"Invalid value")}},m=class{form;formError;submitButton;inputs;constructor(t,e,s){this.form=u(t,HTMLFormElement),this.formError=new f(t,s),this.submitButton=u(`${t}/submit`,HTMLButtonElement);let n=new Map;for(let l of e)n.set(l,new g(t,l));this.inputs=n}clearErrors(){this.formError.clearError();for(let t of this.inputs.values())t.clearError()}setLock(t){this.submitButton.disabled=t;for(let e of this.inputs.values())e.setLock(t)}setInputErrors(t){if(!t||t.length===0){this.formError.addError("an unknown field is invalid");return}for(let e of t){let s=this.inputs.get(e.pointer)??null;s?s.addError(e.detail):this.formError.addError(`field ${e.pointer} ${e.detail}`)}}getValues(){let t=new Map;for(let[e,s]of this.inputs)t.set(e,s.getValue());return t}};function u(r,t){let e=document.getElementById(r);if(!e||!(e instanceof t))throw`element '${r}' does not exist`;return e}var a="token",h=class{#t;#e;#r=null;#s=null;constructor(t,e){this.#t=t,this.#e=e}setBody(t){return this.#s=t,this}setHeaders(t){return this.#r=t,this}async fetch(){return await v(this.#t,this.#e,this.#r,this.#s)}};async function v(r,t,e,s){let n=new Headers;if(e)for(let o of e)n.append(o[0],o[1]);s&&n.append("content-type","application/json");let l=localStorage.getItem(a);l&&!n.has("Authorization")&&n.append("Authorization",l);let d=null;s&&(d=JSON.stringify(s));let i=await self.fetch(t,{method:r,body:d,headers:n}).catch(o=>(console.warn(o),new Response(null,{status:500})));if(i.ok){let o=i.headers.get("Authorization");return o&&localStorage.setItem(a,o),{status:"ok",body:await i.json().catch(L=>(console.warn(L),{}))}}switch(i.status){case 400:return{status:"badRequest",problems:(await i.json().catch(w=>(console.warn(w),{problems:[]}))).problems??[]};case 401:case 403:return{status:"unauthenticated"}}return{status:"error"}}var E="http://localhost:8081",y=["X-TS-API-Key","identity-site"];async function p(r){return location.href=r,await H()}function H(){let r=t=>{setTimeout(()=>r(t),400)};return new Promise(r)}function b(r){return Uint8Array.fromBase64(r,{alphabet:"base64url",lastChunkHandling:"loose"})}function x(){let r=localStorage.getItem(a);if(!r)return null;let t=r.split(".");if(t.length!==3)return localStorage.removeItem(a),null;let e=new TextDecoder,s=JSON.parse(e.decode(b(t[1])));return{bearer:r,act:s.act??null,exp:s.exp,sub:s.sub,typ:s.typ,tid:s.tid}}var k=x();if(k)switch(k.typ){case"common":await p("/identity");break;case"provisioning":await p("/add-passkey");break}var c=new m("/register",["/username","/displayName"],"register");c.form.addEventListener("submit",async r=>{r.preventDefault(),c.setLock(!0),c.clearErrors();let t=c.getValues(),e=t.get("/username")??"",s=t.get("/displayName")??"",n=await new h("POST",E+"/identities").setHeaders([y]).setBody({username:e,displayName:s}).fetch();if(n.status==="ok"&&localStorage.getItem(a)){let d=new URLSearchParams(document.location.search).get("redirect"),i=d?`/add-passkey?redirect=${d}`:"/add-passkey";await p(i)}else n.status==="badRequest"?c.setInputErrors(n.problems):c.formError.panic();c.setLock(!1)});
//# sourceMappingURL=index.js.map
