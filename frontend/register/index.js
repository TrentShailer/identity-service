var k=class{element;contents;constructor(t){this.element=d(`${t}/error`,HTMLElement),this.contents=d(`${t}/error/content`,HTMLElement)}clearError(){this.element.classList.add("collapse"),this.element.ariaHidden="true",this.contents.textContent=""}addError(t){if(this.contents.textContent===""){this.setError(`Invalid form: ${t}`);return}this.contents.textContent+=`, ${t}`}setError(t){this.element.classList.remove("collapse"),this.element.ariaHidden="false",this.contents.textContent=t}unexpectedResponse(t){this.setError(`Could not ${t} because the server sent an unexpected response.`)}},w=class{input;error;constructor(t,e){this.input=d(`${t}${e}/input`,HTMLInputElement),this.error=d(`${t}${e}/error`,HTMLElement),this.input.addEventListener("input",()=>{this.input.setCustomValidity("")})}getValue(){return this.input.type==="checkbox"?this.input.checked?"checked":"unchecked":this.input.value}lock(){this.input.disabled=!0}unlock(){this.input.disabled=!1}clearError(){this.input.setCustomValidity(""),this.error.classList.add("hidden"),this.error.ariaHidden="true",this.error.textContent="!"}addError(t){if(this.error.textContent==="!"){this.setError(`Invalid value: ${t}`);return}this.error.textContent+=`, ${t}`,this.input.setCustomValidity(this.error.textContent??"Invalid value")}setError(t){this.input.setCustomValidity(t),this.error.classList.remove("hidden"),this.error.ariaHidden="false",this.error.textContent=t}},E=class{form;formError;submitButton;inputs;constructor(t,e){this.form=d(t,HTMLFormElement),this.formError=new k(t),this.submitButton=d(`${t}/submit`,HTMLButtonElement);let s=new Map;for(let n of e)s.set(n,new w(t,n));this.inputs=s}clearErrors(){this.formError.clearError();for(let t of this.inputs.values())t.clearError()}lock(){this.submitButton.disabled=!0;for(let t of this.inputs.values())t.lock()}unlock(){this.submitButton.disabled=!1;for(let t of this.inputs.values())t.unlock()}setInputErrors(t){if(!t||t.length===0){this.formError.addError("an unknown field is invalid");return}for(let e of t){let s=null;e.pointer&&(s=this.inputs.get(e.pointer)??null),s&&e.detail?s.addError(e.detail):s&&!e.detail?s.addError("unknown reason"):!s&&e.detail?this.formError.addError(e.detail):this.formError.addError("an unknown field is invalid")}}getValues(){let t=new Map;for(let[e,s]of this.inputs)t.set(e,s.getValue());return t}};function d(r,t){let e=document.getElementById(r);if(!e||!(e instanceof t))throw`element '${r}' does not exist`;return e}async function h(r){return location.href=r,await L()}function L(){let r=t=>{setTimeout(()=>r(t),400)};return new Promise(r)}var o="token",u=class{#t;#e;#r=null;#s=null;#n=null;#o=!1;constructor(t,e){this.#t=t,this.#e=e}setBody(t){return this.#s=t,this}setHeaders(t){return this.#r=t,this}setLogout(t,e){return this.#n=t,this.#o=e,this}async fetch(){return await T(this.#t,this.#e,this.#r,this.#s,this.#n,this.#o)}};async function T(r,t,e,s,n,g){let i=new Headers;if(e)for(let l of e)i.append(l[0],l[1]);s&&i.append("content-type","application/json");let m=localStorage.getItem(o);m&&!i.has("Authorization")&&i.append("Authorization",m);let y=null;s&&(y=JSON.stringify(s));let a=await self.fetch(t,{method:r,body:y,headers:i}).catch(l=>(console.warn(l),new Response(null,{status:500})));if(a.ok){let l=a.headers.get("Authorization");return l&&localStorage.setItem(o,l),{status:"ok",body:await a.json().catch(H=>(console.warn(H),{}))}}else return a.status===401?(n&&await I(n,g),{status:"unauthorized"}):a.status===404?{status:"notFound"}:a.status>=400&&a.status<500?{status:"clientError",problems:(await a.json().catch(x=>(console.warn(x),{problems:[]}))).problems??[]}:{status:"serverError"}}async function I(r,t){let e=localStorage.getItem(o);await new u("DELETE",r.deleteTokenEndpoint).setHeaders(r.additionalHeaders).fetch(),localStorage.removeItem(o),e&&alert("Your session has expired");let s=t?`${r.loginHref}?redirect=${encodeURI(location.href)}`:r.loginHref;return await h(s)}var p="http://localhost:8081",f=["X-TS-API-Key","identity-site"],A={deleteTokenEndpoint:p+"/tokens/current",loginHref:"/login",additionalHeaders:[f]};async function b(){let r=await new u("GET",p+"/tokens/current").setHeaders([f]).fetch();return r.status==="serverError"||r.status==="clientError"||r.status==="unauthorized"?(localStorage.removeItem(o),null):r.status==="ok"?r.body:(localStorage.removeItem(o),null)}var v=await b();if(v)switch(v.typ){case"common":await h("/identity");break;case"provisioning":await h("/add-passkey");break}var c=new E("/register",["/username","/displayName"]);c.form.addEventListener("submit",async r=>{r.preventDefault(),c.lock(),c.clearErrors();let t=c.getValues(),e=t.get("/username")??"",s=t.get("/displayName")??"",n=await new u("POST",p+"/identities").setHeaders([f]).setBody({username:e,displayName:s}).fetch();if(n.status==="ok"&&localStorage.getItem(o)){let i=new URLSearchParams(document.location.search).get("redirect"),m=i?`/add-passkey?redirect=${i}`:"/add-passkey";await h(m)}else n.status==="clientError"?c.setInputErrors(n.problems):c.formError.unexpectedResponse("register");c.unlock()});
//# sourceMappingURL=index.js.map
